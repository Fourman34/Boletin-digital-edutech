<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="icon" href="imagenes/logo.webp" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Materias</title>
    <link rel="stylesheet" href="index1.css">
    <style>
        /* Estilos adicionales para la tabla */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }

        th {
            background-color: #f2f2f2;
        }

        td[contenteditable="true"] {
            background-color: #f9f9f9;
        }

        .aprobado {
            background-color: #d4edda;
        }

        .reprobado {
            background-color: #f8d7da;
        }
    </style>
</head>
<body>
    <header>
        <img id="Logo" src="imagenes/logo.webp" height="90" width="90">
        <h1>Colegio Provincial Dr. Ernesto Guevara</h1>
    </header>
    
    <nav>
        <ul>
            <li><a href="index1.html">Inicio</a></li>
            <li><a href="calendario.html">Calendario</a></li>
            <li><a href="contactar.html">Contacto</a></li>
            <li><a href="matricularse.html">Matricularse</a></li>
            <li id="materiasLink"><a href="#" id="materiasEnlace">Materias</a></li>
            <li id="adminLink"><a href="administrador.html">Administradores</a></li>
        </ul>
    </nav>
    <main>
        <h2>Bienvenido <span id="nombreUsuario"></span></h2> <!-- Mostrar el nombre del usuario -->

        <!-- Selector de alumnos -->
        <div class="selector-alumno">
            <label for="alumno">Selecciona un alumno:</label>
            <select id="alumno">
                <!-- Los alumnos se cargarán dinámicamente desde el backend -->
            </select>
        </div>

        <!-- Selector de materias -->
        <div class="selector-materia">
            <label for="materia">Selecciona una materia:</label>
            <select id="materia">
                <!-- Las materias se cargarán dinámicamente desde el backend -->
            </select>
        </div>        
        <table id="tablaNotas">
            <thead>
                <tr>
                    <th colspan="3">Alumno</th>
                    <th colspan="3">Primer Cuatrimestre</th>
                    <th colspan="3">Segundo Cuatrimestre</th>
                    <th>Nota Final</th>
                    <th>Nota Diciembre</th>
                    <th>Nota Febrero/Marzo</th>
                </tr>
                <tr>
                    <th colspan="3"></th>
                    <th>1° Informe</th>
                    <th>2° Informe</th>
                    <th>Nota</th>
                    <th>1° Informe</th>
                    <th>2° Informe</th>
                    <th>Nota</th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <!-- Las filas de alumnos se llenarán dinámicamente desde el backend -->
            </tbody>
        </table>
        <button id="guardar">Guardar Notas</button>
        <button id="exportar">Exportar a CSV</button>
    </main>
<br>
<br>
<br>
<br>
    <footer>
        <p>&copy; 2024 EduTech. Derechos Reservados.</p>
    </footer>
    <button onclick="cerrarSesion()" style="position: fixed; bottom: 20px; right: 20px; padding: 10px; background-color: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer;">
        Cerrar sesión
    </button>

    <script>
        // Función para cargar el nombre del usuario desde localStorage
        document.addEventListener("DOMContentLoaded", () => {
            const usuario = JSON.parse(localStorage.getItem('usuario'));
            if (usuario) {
                document.getElementById('nombreUsuario').textContent = usuario.nombre;
            } else {
                alert("Debes iniciar sesión para acceder a esta página.");
                window.location.href = 'login.html'; // Redirigir a la página de inicio de sesión
            }
        });

        // Función para cerrar sesión
        function cerrarSesion() {
            localStorage.removeItem('usuario'); // Eliminar el usuario de localStorage
            window.location.href = 'login.html'; // Redirigir a la página de inicio de sesión
        }
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const tabla = document.getElementById("tablaNotas");
            const guardarBtn = document.getElementById("guardar");
            const exportarBtn = document.getElementById("exportar");
            const selectorMateria = document.getElementById("materia");
            const selectorAlumno = document.getElementById("alumno");

            // Cargar materias y alumnos al iniciar la página
            cargarMaterias();
            cargarAlumnos();

            // Evento para guardar notas al hacer clic en el botón
            guardarBtn.addEventListener("click", async function () {
                const notas = obtenerNotasDeLaTabla();
                const resultado = await enviarNotasAlServidor(notas);

                if (resultado === "éxito") {
                    alert("Notas guardadas correctamente.");
                } else {
                    alert("Hubo un error al guardar las notas.");
                }
            });

            // Evento para exportar notas a CSV
            exportarBtn.addEventListener("click", exportarACSV);

            // Función para cargar materias desde el servidor
            async function cargarMaterias() {
                try {
                    const response = await fetch("http://localhost:3000/obtener-materias");
                    if (response.ok) {
                        const materias = await response.json();
                        selectorMateria.innerHTML = materias.map(materia => 
                            `<option value="${materia.nombre}">${materia.nombre}</option>`
                        ).join("");
                    } else {
                        alert("Hubo un error al cargar las materias.");
                    }
                } catch (error) {
                    console.error("Error al cargar las materias:", error);
                }
            }

            // Función para cargar alumnos desde el servidor
            async function cargarAlumnos() {
                try {
                    const response = await fetch("http://localhost:3000/obtener-alumnos");
                    if (response.ok) {
                        const alumnos = await response.json();
                        actualizarSelectorDeAlumnos(alumnos);
                    } else {
                        alert("Hubo un error al cargar los alumnos.");
                    }
                } catch (error) {
                    console.error("Error al cargar los alumnos:", error);
                }
            }

            // Función para actualizar el selector de alumnos
            function actualizarSelectorDeAlumnos(alumnos) {
                selectorAlumno.innerHTML = alumnos.map(alumno => 
                    `<option value="${alumno.ID_usuario}">${alumno.nombre} ${alumno.apellido}</option>`
                ).join("");
            }

            // Función para obtener las notas de la tabla
            function obtenerNotasDeLaTabla() {
                const notas = [];
                const filas = tabla.querySelectorAll("tbody tr");
                const ID_usuario = selectorAlumno.value; // Obtener el ID_usuario del alumno seleccionado

                filas.forEach(fila => {
                    const celdas = fila.querySelectorAll("td[contenteditable]");

                    const filaNotas = {
                        ID_usuario: ID_usuario,
                        materia: selectorMateria.value,
                        primer_cuatrimestre_1: celdas[0].textContent.trim(),
                        primer_cuatrimestre_2: celdas[1].textContent.trim(),
                        primer_cuatrimestre_nota: celdas[2].textContent.trim(),
                        segundo_cuatrimestre_1: celdas[3].textContent.trim(),
                        segundo_cuatrimestre_2: celdas[4].textContent.trim(),
                        segundo_cuatrimestre_nota: celdas[5].textContent.trim(),
                        nota_final: fila.cells[9].textContent.trim(),
                        nota_diciembre: celdas[6].textContent.trim(),
                        nota_febrero_marzo: celdas[7].textContent.trim(),
                    };
                    notas.push(filaNotas);
                });

                return notas;
            }

            // Función para enviar notas al servidor
            async function enviarNotasAlServidor(notas) {
                try {
                    const response = await fetch("http://localhost:3000/guardar-notas", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify(notas),
                    });

                    if (response.ok) {
                        return "éxito";
                    } else {
                        return "error";
                    }
                } catch (error) {
                    console.error("Error al enviar las notas:", error);
                    return "error";
                }
            }

            // Función para exportar notas a CSV
            function exportarACSV() {
                const filas = tabla.querySelectorAll("tbody tr");
                let csvContent = "data:text/csv;charset=utf-8,";

                // Encabezados
                csvContent += "Alumno,Primer Cuatrimestre 1,Primer Cuatrimestre 2,Primer Cuatrimestre Nota,Segundo Cuatrimestre 1,Segundo Cuatrimestre 2,Segundo Cuatrimestre Nota,Nota Final,Nota Diciembre,Nota Febrero/Marzo\n";

                // Datos
                filas.forEach(fila => {
                    const celdas = fila.querySelectorAll("td");
                    const filaData = Array.from(celdas).map(celda => celda.textContent).join(",");
                    csvContent += filaData + "\n";
                });

                // Descargar archivo
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "notas.csv");
                document.body.appendChild(link);
                link.click();
            }
        });
    </script>
</body>
</html>